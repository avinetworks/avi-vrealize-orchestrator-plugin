package com.avi.avi.model;

import org.json.JSONObject;
import org.json.JSONArray;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.json.simple.JSONValue;

import java.io.BufferedReader;
import java.io.Closeable;
import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;
import java.io.IOException;

public class Pool {
	// Pool enum properties declaration
	private enum lb_algorithm_type {LB_ALGORITHM_LEAST_CONNECTIONS};
	private enum lb_algorithm_hash_type  {LB_ALGORITHM_CONSISTENT_HASH_SOURCE_IP_ADDRESS};
	
	// Pool properties go here
	private String url;
	private String uuid;
	private String  name;
	private Boolean enabled;
	private String tenant_ref;
	private String cloud_ref;
	private String last_modified;
	private lb_algorithm_type lb_algorithm;
	private Boolean use_service_port;
	private Boolean rewrite_host_header_to_server_name;
	private Boolean host_check_enabled;
	// TODO: conn_pool_properties declaration
	//	conn_pool_properties": {
	//		upstream_connpool_conn_life_tmo": 600000,
	//		upstream_connpool_server_max_cache": 0,
	//		upstream_connpool_conn_max_reuse": 0,
	//		upstream_connpool_conn_idle_tmo": 60000
	//	},
	private Boolean rewrite_host_header_to_sni;
	private Boolean delete_server_on_dns_refresh;
	private Boolean capacity_estimation;
	private Integer fewest_tasks_feedback_delay;
	private Integer capacity_estimation_ttfb_thresh;
	// TODO: fail_action declaration
	//	fail_action": {
	//		type": "FAIL_ACTION_CLOSE_CONN"
	//	},
	private Boolean lookup_server_by_name;
	private lb_algorithm_hash_type lb_algorithm_hash;
	private String analytics_profile_ref;
	private Integer lb_algorithm_core_nonaffinity;
	private Integer graceful_disable_timeout;
	private String vrf_ref;
	private Boolean inline_health_monitor;
	private Integer default_server_port;
	private Integer request_queue_depth;
	// TODO: server_reselect declaration
	//	server_reselect": {
	//		retry_nonidempotent": false,
	//		enabled": false,
	//		retry_timeout": 0,
	//		num_retries": 4
	//	},
	private Boolean sni_enabled;
	private Integer server_timeout;
	private Boolean request_queue_enabled;
	private Integer max_concurrent_connections_per_server;
	private Integer connection_ramp_duration;
	// TODO: analytics_policy declaration
	//	analytics_policy": {
	//		enable_realtime_metrics": false
	//	}
	
	// Property setter functions go here
	public String  set_name(String value){
		this.name = value;
		return null;
	}
	
	public Boolean set_enabled(Boolean value){
		this.enabled = value;
		return null;
	}
	
	public String set_tenant_ref(String value){
		this.tenant_ref = value;
		return null;
	}
	
	public String set_cloud_ref(String value){
		this.cloud_ref = value;
		return null;
	}
	
	public Boolean set_lb_algorithm(String value){
		this.lb_algorithm = lb_algorithm_type.valueOf(value);
		return true;
	}
	public Boolean set_use_service_port(Boolean value){
		this.use_service_port = value;
		return null;
	}
	
	public Boolean set_rewrite_host_header_to_server_name(Boolean value){
		this.rewrite_host_header_to_server_name = value;
		return null;
	}
	
	public Boolean set_host_check_enabled(Boolean value){
		this.host_check_enabled = value;
		return null;
	}
	
	// TODO: conn_pool_properties declaration
	//	conn_pool_properties": {
	//		upstream_connpool_conn_life_tmo": 600000,
	//		upstream_connpool_server_max_cache": 0,
	//		upstream_connpool_conn_max_reuse": 0,
	//		upstream_connpool_conn_idle_tmo": 60000
	//	},
	public Boolean set_rewrite_host_header_to_sni(Boolean value){
		this.rewrite_host_header_to_sni = value;
		return null;
	}
	
	public Boolean set_delete_server_on_dns_refresh(Boolean value){
		this.delete_server_on_dns_refresh = value;
		return null;
	}
	
	public Boolean set_capacity_estimation(Boolean value){
		this.capacity_estimation = value;
		return null;
	}
	
	public Integer set_fewest_tasks_feedback_delay(Integer value){
		this.fewest_tasks_feedback_delay = value;
		return null;
	}

	public Integer set_capacity_estimation_ttfb_thresh(Integer value){
		this.capacity_estimation_ttfb_thresh = value;
		return null;
	}
	
	// TODO: fail_action setter function
	//public Boolean set_fail_action(String value){
	//	 return null;
	//}
	
	public Boolean set_lookup_server_by_name(Boolean value){
		this.lookup_server_by_name = value;
		return null;
	}
	
	public Boolean set_lb_algorithm_hash(String value){
		this.lb_algorithm_hash = lb_algorithm_hash_type.valueOf(value);
		return true;
	}
	
	public String set_analytics_profile_ref(String value){
		this.analytics_profile_ref = value;
		return null;
	}
	
	public Integer set_lb_algorithm_core_nonaffinity(Integer value){
		this.lb_algorithm_core_nonaffinity = value;
		return null;
	}
	
	public Integer set_graceful_disable_timeout(Integer value){
		this.graceful_disable_timeout = value;
		return null;
	}
	
	public Boolean set_inline_health_monitor(Boolean value){
		this.inline_health_monitor = value;
		return null;
	}
	
	public Integer set_default_server_port(Integer value){
		this.default_server_port = value;
		return null;
	}
	
	public Integer set_request_queue_depth(Integer value){
		this.request_queue_depth = value;
		return null;
	}
	
	// TODO: server_reselect setter function
	// public Integer set_server_reselect(String value){
	//	 return null;
	// }

	public Boolean set_sni_enabled(Boolean value){
		this.sni_enabled = value;
		return null;
	}
	
	public Integer set_server_timeout(Integer value){
		this.server_timeout = value;
		return null;
	}
	
	public Boolean set_request_queue_enabled(Boolean value){
		this.request_queue_enabled = value;
		return null;
	}
	
	public Integer set_max_concurrent_connections_per_server(Integer value){
		this.max_concurrent_connections_per_server = value;
		return null;
	}
	
	public Integer set_connection_ramp_duration(Integer value){
		this.connection_ramp_duration = value;
		return null;
	}
	// TODO: analytics_policy setter function
	// public Integer set_analytics_policy(String value){
	// 	return null;
	// }
	
	
	// Property getter functions go here
	public String  get_name(String value){
		this.name = value;
		return null;
	}
	
	public Boolean get_enabled(Boolean value){
		this.enabled = value;
		return null;
	}
	
	public String get_tenant_ref(){
		return this.tenant_ref;
	}
	
	public String get_cloud_ref(){
		return this.cloud_ref;
	}
	
	public lb_algorithm_type get_lb_algorithm(){
		return this.lb_algorithm;
	}
	public Boolean get_use_service_port(){
		return this.use_service_port;
	}
	
	public Boolean get_rewrite_host_header_to_server_name(){
		return this.rewrite_host_header_to_server_name;
	}
	
	public Boolean get_host_check_enabled(){
		return this.host_check_enabled;
	}
	
	public Boolean get_rewrite_host_header_to_sni(){
		return this.rewrite_host_header_to_sni;
	}
	
	public Boolean get_delete_server_on_dns_refresh(){
		return this.delete_server_on_dns_refresh;
	}
	
	public Boolean get_capacity_estimation(){
		return this.capacity_estimation;
	}
	
	public Integer get_fewest_tasks_feedback_delay(){
		return this.fewest_tasks_feedback_delay;
	}

	public Integer get_capacity_estimation_ttfb_thresh(){
		return this.capacity_estimation_ttfb_thresh;
	}
	
	// TODO: fail_action setter function
	//public Boolean set_fail_action(String value){
	//	 return null;
	//}
	
	public Boolean get_lookup_server_by_name(){
		return this.lookup_server_by_name;
	}
	
	public lb_algorithm_hash_type get_lb_algorithm_hash(){
		return this.lb_algorithm_hash;
	}
	
	public String get_analytics_profile_ref(){
		return this.analytics_profile_ref;
	}
	
	public Integer get_lb_algorithm_core_nonaffinity(){
		return this.lb_algorithm_core_nonaffinity;
	}
	
	public Integer get_graceful_disable_timeout(){
		return this.graceful_disable_timeout;
	}
	
	public Boolean get_inline_health_monitor(){
		return this.inline_health_monitor;
	}
	
	public Integer get_default_server_port(){
		return this.default_server_port;
	}
	
	public Integer get_request_queue_depth(){
		return this.request_queue_depth;
	}
	
	// TODO: server_reselect getter function
	// public Integer get_server_reselect(){
	//	 return null;
	// }

	public Boolean get_sni_enabled(){
		return this.sni_enabled;
	}
	
	public Integer get_server_timeout(){
		return this.server_timeout;
	}
	
	public Boolean get_request_queue_enabled(){
		return this.request_queue_enabled;
	}
	
	public Integer get_max_concurrent_connections_per_server(){
		return this.max_concurrent_connections_per_server;
	}
	
	public Integer get_connection_ramp_duration(){
		return this.connection_ramp_duration;
	}
	// TODO: analytics_policy getter function
	// public Integer get_analytics_policy(){
	// 	return null;
	// }

	public String create(String controllerIP, String username, String password) throws IOException {
		try {
			String postURL = controllerIP + "/api/pool/";
			URL url = new URL(postURL);
			String creds = username + ":" + password;
			String encoding = Base64.getEncoder().encodeToString((creds).getBytes("UTF-8"));
			HttpURLConnection con = (HttpURLConnection) url.openConnection();
			con.setRequestMethod("POST");
			con.setRequestProperty("Content-Type", "application/json");
			con.setRequestProperty("X-Avi-Version", "18.2.3");
			con.setRequestProperty("Authorization", "Basic " + encoding);

			con.setDoOutput(true);

			// Send data of object
			this.sendData(con, this.data);

			// Read response from REST call
			this.data = this.read(con.getInputStream());
			return data;
		} catch (IOException exception) {
			return exception.toString();
		}
	}

	public void sendData(HttpURLConnection con, String data) throws IOException {
		DataOutputStream wr = null;
		try {
			wr = new DataOutputStream(con.getOutputStream());
			wr.writeBytes(data);
			wr.flush();
			wr.close();
		} catch (IOException exception) {
			throw exception;
		} finally {
			this.closeQuietly(wr);
		}
	}

	public String read(InputStream is) throws IOException {
		BufferedReader in = null;
		String inputLine;
		StringBuilder body;
		try {
			in = new BufferedReader(new InputStreamReader(is));

			body = new StringBuilder();

			while ((inputLine = in.readLine()) != null) {
				body.append(inputLine);
			}
			in.close();

			return body.toString();
		} catch (IOException ioe) {
			throw ioe;
		} finally {
			this.closeQuietly(in);
		}
	}

	public void closeQuietly(Closeable closeable) {
		try {
			if (closeable != null) {
				closeable.close();
			}
		} catch (IOException ex) {

		}
	}

	public boolean delete(String controllerIP, String username, String password) throws IOException {
		 JSONObject jObject = new JSONObject(data);
		 String uuid = (String) jObject.get("uuid");
		 String postURL = controllerIP + "/api/pool/"+ uuid;
		 URL url = new URL(postURL);
		 String creds = username + ":" + password;
		 String encoding = Base64.getEncoder().encodeToString((creds).getBytes("UTF-8"));
		 HttpURLConnection con = (HttpURLConnection) url.openConnection();
		 con.setRequestMethod("DELETE");
		 con.setRequestProperty("X-Avi-Version", "18.2.3");
		 con.setRequestProperty("Authorization", "Basic " + encoding);
		  
		 con.setDoOutput(true);
		 
		 this.read(con.getInputStream());
		 this.data = null;
		 return true;
		 
	}
}